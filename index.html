<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Empyre Singles</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
.hidden{display:none}
header{text-align:center;padding:10px}
h1{color:#e10600;font-size:28px;margin:0}
h2{font-weight:normal;margin-top:3px;font-size:14px}
.container{max-width:400px;margin:auto;padding:5px}
input,button{padding:3px 6px;margin:2px;background:#111;border:1px solid #e10600;color:#fff;font-size:12px;border-radius:3px}
button{cursor:pointer}
#cards{max-height:250px;overflow-y:auto}
#adminList{max-height:250px;overflow-y:auto;display:flex;flex-wrap:wrap;gap:4px}
.card{border:1px solid #e10600;padding:4px;margin:2px;background:#0b0b0b;position:relative;font-size:12px;border-radius:4px;display:flex;justify-content:space-between;align-items:center}
.card-info{display:flex;flex-direction:column;}
.delete{cursor:pointer;color:#e10600;font-weight:bold;margin-left:4px}
.footer{position:fixed;bottom:0;width:100%;background:#050505;padding:8px;text-align:center;font-size:12px}
#adminPanel{position:fixed;bottom:0;width:100%;background:#080808;border-top:2px solid #e10600;padding:5px;max-height:300px;overflow-y:auto;font-size:12px}
.admin-card{border:1px solid #333;padding:3px;margin:2px;flex:1 1 140px;border-radius:4px;display:flex;flex-direction:column}
.admin-card input, .admin-card button{width:auto;margin:1px;padding:2px;font-size:11px}
canvas{margin-top:5px;width:100% !important;height:180px !important;}
</style>
</head>
<body>

<!-- ACCESO -->
<div id="access" class="container">
 <h2>Clave de acceso</h2>
 <input type="password" id="accessPin" placeholder="Introduce clave">
 <button onclick="enter()">Entrar</button>
</div>

<!-- APP -->
<div id="app" class="hidden">
<header>
 <h1>Empyre Singles</h1>
 <h2>Intercambio candente</h2>
</header>

<div class="container">
<h3>Crear ficha</h3>
<input id="userInput" placeholder="@usuario">
<input id="fetishInput" placeholder="Fetiche">
<p>Redpoints: ??</p>
<button onclick="createCard()">Crear</button>

<div id="cards"></div>
<canvas id="chart"></canvas>
</div>

<div class="footer">
 <button onclick="openAdmin()">Administración</button>
</div>

<div id="adminPanel" class="hidden">
 <h3>Administración</h3>
 <input type="password" id="adminPin" placeholder="PIN admin">
 <button onclick="loginAdmin()">Entrar</button>
 <div id="adminContent" class="hidden">
  <button onclick="toggleCoins()">Mostrar / Ocultar monedas</button>
  <button onclick="resetGame()">Cerrar juego</button>
  <button onclick="closeAdmin()">X</button>
  <h4>Editar fichas</h4>
  <div id="adminList"></div>
  <h4>Cambiar contraseña de acceso</h4>
  <input type="password" id="newAccessPin" placeholder="Nueva clave de acceso">
  <button onclick="changeAccessPin()">Guardar clave</button>
 </div>
</div>

<script>
let accessPassword="2025"; // clave inicial
const firebaseConfig={
 apiKey:"AIzaSyAFbvgQ90F3LK6bdjIV9ZrklqG7AOa_SP8",
 authDomain:"empyre-singles-4d9e5.firebaseapp.com",
 projectId:"empyre-singles-4d9e5",
 storageBucket:"empyre-singles-4d9e5.firebasestorage.app",
 messagingSenderId:"131407484794",
 appId:"1:131407484794:web:1041dce4e48264713368c3"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const stateRef=db.collection("state").doc("game");

stateRef.get().then(d=>{
 if(!d.exists){stateRef.set({showCoins:false});}
});

let isAdmin=false;
let chart;

// ACCESO
function enter(){
 if(accessPin.value===accessPassword){
  access.classList.add("hidden");
  app.classList.remove("hidden");
 } else { alert("Clave incorrecta"); }
}

// ADMIN
function openAdmin(){adminPanel.classList.remove("hidden");}
function loginAdmin(){
 if(adminPin.value==="0204"){
  isAdmin=true;
  adminContent.classList.remove("hidden");
  renderCards();
 }
}
function closeAdmin(){
 isAdmin=false;
 adminPanel.classList.add("hidden");
 adminContent.classList.add("hidden");
 adminPin.value="";
}

// CREAR FICHA
function createCard(){
 if(!userInput.value||!fetishInput.value)return;
 db.collection("cards").add({
  user:userInput.value,
  fetish:fetishInput.value,
  coins:10,
  price:0
 });
 userInput.value="";
 fetishInput.value="";
}

// TOGGLE MONEDAS
function toggleCoins(){
 stateRef.get().then(d=>{
  stateRef.update({showCoins:!d.data().showCoins});
 });
}

// RESET
function resetGame(){
 if(confirm("¿Cerrar juego y borrar todo?")){
  db.collection("cards").get().then(s=>{
   s.forEach(d=>d.ref.delete());
  });
  stateRef.set({showCoins:false});
 }
}

// BORRAR FICHA
function deleteCard(id){
 if(confirm("¿Borrar ficha?")){
  db.collection("cards").doc(id).delete();
 }
}

// GUARDAR CAMBIOS ADMIN
function save(id){
 const coins=document.getElementById("coins-"+id).value;
 const price=document.getElementById("price-"+id).value;
 db.collection("cards").doc(id).update({
  coins:Number(coins),
  price:Number(price)
 });
}

// CAMBIAR CLAVE DE ACCESO
function changeAccessPin(){
 if(newAccessPin.value){
  accessPassword=newAccessPin.value;
  alert("Clave de acceso cambiada!");
  newAccessPin.value="";
 }
}

// RENDER CARDS
function renderCards(){
 db.collection("cards").get().then(s=>{
  stateRef.get().then(st=>{
   const visible=st.data().showCoins;
   cards.innerHTML="";
   adminList.innerHTML="";
   const graph=[];
   s.forEach(d=>{
    const c=d.data();
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
     <div class="card-info">
      <b>${c.user}</b> | ${c.fetish} <br>
      Redpoints: ${visible?c.coins:"??"} | Precio: ${c.price}
     </div>
     <span class="delete" data-id="${d.id}">X</span>
    `;
    cards.appendChild(div);

    if(isAdmin){
     const a=document.createElement("div");
     a.className="admin-card";
     a.innerHTML=`
      <b>${c.user}</b><br>
      Coins: <input type="number" id="coins-${d.id}" value="${c.coins}">
      Precio: <input type="number" id="price-${d.id}" value="${c.price}">
      <button onclick="save('${d.id}')">Guardar</button>
     `;
     adminList.appendChild(a);
    }

    graph.push({u:c.user,c:c.coins});
   });

   updateChart(graph);
  });
 });
}

// EVENT DELEGATION PARA X
cards.addEventListener('click', e=>{
 if(e.target.classList.contains('delete')){
   const id=e.target.dataset.id;
   deleteCard(id);
 }
});

// LISTENERS EN TIEMPO REAL
db.collection("cards").onSnapshot(renderCards);
stateRef.onSnapshot(renderCards);

// GRAFICA
function updateChart(data){
 if(chart)chart.destroy();
 chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{
   labels:data.map(d=>d.u),
   datasets:[{data:data.map(d=>d.c),borderColor:"#e10600",fill:false}]
  },
  options:{plugins:{legend:{display:false}}}
 });
}
</script>
</body>
</html>
