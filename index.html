<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Empyre Singles</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
 background:#000;
 color:#fff;
 font-family:Arial,Helvetica,sans-serif;
 margin:0;
}
.hidden{display:none}
header{
 text-align:center;
 padding:20px;
}
h1{
 color:#e10600;
 font-size:40px;
 margin:0;
}
h2{
 font-weight:normal;
 margin:5px 0 20px;
}
input,button,select{
 background:#111;
 border:1px solid #e10600;
 color:#fff;
 padding:8px;
 margin:5px 0;
 width:100%;
}
button{
 cursor:pointer;
}
.container{
 max-width:900px;
 margin:auto;
 padding:10px;
}
.card{
 border:1px solid #e10600;
 padding:10px;
 margin:10px 0;
 position:relative;
 background:#0b0b0b;
}
.card .delete{
 position:absolute;
 top:5px;
 right:8px;
 cursor:pointer;
 color:#e10600;
 font-weight:bold;
}
.footer-admin{
 position:fixed;
 bottom:0;
 width:100%;
 background:#050505;
 padding:10px;
 text-align:center;
}
#adminPanel{
 background:#080808;
 padding:10px;
 border-top:2px solid #e10600;
}
canvas{
 background:#000;
 margin-top:20px;
}
</style>
</head>

<body>

<div id="accessScreen" class="container">
 <h2>Clave de acceso</h2>
 <input type="password" id="accessPin" placeholder="Clave">
 <button onclick="enterApp()">Entrar</button>
</div>

<div id="app" class="hidden">

<header>
 <h1>Empyre Singles</h1>
 <h2>Intercambio candente</h2>
</header>

<div class="container">

<h3>Crear ficha</h3>
<input id="userInput" placeholder="@usuario">
<input id="fetishInput" placeholder="Fetiche">
<p>Monedas: ??</p>
<button onclick="createCard()">Crear</button>

<div id="cards"></div>

<canvas id="chart"></canvas>

</div>

<div class="footer-admin">
 <button onclick="openAdmin()">Administración</button>
</div>

<div id="adminPanel" class="hidden">
 <h3>Panel admin</h3>
 <input type="password" id="adminPin" placeholder="PIN admin">
 <button onclick="enterAdmin()">Entrar</button>

 <div id="adminControls" class="hidden">
  <select id="userSelect"></select>
  <input type="number" id="editCoins" placeholder="Redpoints">
  <input type="number" id="editPrice" placeholder="Precio fetiche">
  <button onclick="saveEdit()">Guardar</button>
  <button onclick="toggleCoins()">Mostrar / Ocultar monedas</button>
  <button onclick="closeGame()">Cerrar juego</button>
  <button onclick="exitAdmin()">X</button>
 </div>
</div>

</div>

<script>
const firebaseConfig={
 apiKey:"AIzaSyAFbvgQ90F3LK6bdjIV9ZrklqG7AOa_SP8",
 authDomain:"empyre-singles-4d9e5.firebaseapp.com",
 projectId:"empyre-singles-4d9e5",
 storageBucket:"empyre-singles-4d9e5.firebasestorage.app",
 messagingSenderId:"131407484794",
 appId:"1:131407484794:web:1041dce4e48264713368c3"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let admin=false;
let showCoins=false;
let chart;

function enterApp(){
 if(document.getElementById("accessPin").value==="2025"){
  accessScreen.classList.add("hidden");
  app.classList.remove("hidden");
 }
}

function openAdmin(){
 adminPanel.classList.remove("hidden");
}

function enterAdmin(){
 if(adminPin.value==="0204"){
  admin=true;
  adminControls.classList.remove("hidden");
  populateSelect();
 }
}

function exitAdmin(){
 admin=false;
 adminPanel.classList.add("hidden");
 adminControls.classList.add("hidden");
 adminPin.value="";
}

function createCard(){
 const user=userInput.value;
 const fetish=fetishInput.value;
 if(!user||!fetish)return;
 db.collection("cards").add({
  user,fetish,
  coins:10,
  price:0
 });
 userInput.value="";
 fetishInput.value="";
}

function populateSelect(){
 userSelect.innerHTML="";
 db.collection("cards").get().then(s=>{
  s.forEach(d=>{
   const o=document.createElement("option");
   o.value=d.id;
   o.textContent=d.data().user;
   userSelect.appendChild(o);
  });
 });
}

function saveEdit(){
 const id=userSelect.value;
 if(!id)return;
 db.collection("cards").doc(id).update({
  coins:Number(editCoins.value),
  price:Number(editPrice.value)
 });
 editCoins.value="";
 editPrice.value="";
}

function toggleCoins(){
 showCoins=!showCoins;
}

function closeGame(){
 if(confirm("¿Cerrar juego y borrar todo?")){
  db.collection("cards").get().then(s=>{
   s.forEach(d=>d.ref.delete());
  });
  showCoins=false;
 }
}

db.collection("cards").onSnapshot(s=>{
 cards.innerHTML="";
 const data=[];
 s.forEach(d=>{
  const c=d.data();
  const div=document.createElement("div");
  div.className="card";
  div.innerHTML=`
   <span class="delete" onclick="deleteCard('${d.id}')">X</span>
   <b>${c.user}</b><br>
   ${c.fetish}<br>
   ${showCoins?"Redpoints: "+c.coins:"Redpoints: ??"}<br>
   Precio: ${c.price}
  `;
  cards.appendChild(div);
  data.push({user:c.user,coins:c.coins});
 });
 updateChart(data);
 populateSelect();
});

function deleteCard(id){
 if(confirm("¿Borrar ficha?")){
  db.collection("cards").doc(id).delete();
 }
}

function updateChart(data){
 if(chart)chart.destroy();
 chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{
   labels:data.map(d=>d.user),
   datasets:[{
    data:data.map(d=>d.coins),
    borderColor:"#e10600",
    fill:false
   }]
  },
  options:{plugins:{legend:{display:false}}}
 });
}
</script>

</body>
</html>
