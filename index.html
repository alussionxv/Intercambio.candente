<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Empyre Singles</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
 margin:0;
 background:#000;
 color:#fff;
 font-family:Arial,Helvetica,sans-serif;
}
.hidden{display:none}
header{text-align:center;padding:20px}
h1{color:#e10600;font-size:42px;margin:0}
h2{font-weight:normal;margin-top:5px}

.container{max-width:900px;margin:auto;padding:10px}
input,button{
 width:100%;
 padding:8px;
 margin:5px 0;
 background:#111;
 border:1px solid #e10600;
 color:#fff;
}
button{cursor:pointer}

.card{
 border:1px solid #e10600;
 padding:10px;
 margin:10px 0;
 background:#0b0b0b;
 position:relative;
}
.delete{
 position:absolute;
 top:5px;
 right:8px;
 cursor:pointer;
 color:#e10600;
 font-weight:bold;
}

.footer{
 position:fixed;
 bottom:0;
 width:100%;
 background:#050505;
 padding:10px;
 text-align:center;
}

#adminPanel{
 background:#080808;
 border-top:2px solid #e10600;
 padding:10px;
}

.admin-card{
 border:1px solid #333;
 padding:10px;
 margin:10px 0;
}
canvas{margin-top:20px}
</style>
</head>

<body>

<!-- ACCESO -->
<div id="access" class="container">
 <h2>Clave de acceso</h2>
 <input type="password" id="accessPin" placeholder="2025">
 <button onclick="enter()">Entrar</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<header>
 <h1>Empyre Singles</h1>
 <h2>Intercambio candente</h2>
</header>

<div class="container">

<h3>Crear ficha</h3>
<input id="userInput" placeholder="@usuario">
<input id="fetishInput" placeholder="Fetiche">
<p>Redpoints: ??</p>
<button onclick="createCard()">Crear</button>

<div id="cards"></div>

<canvas id="chart"></canvas>

</div>

<div class="footer">
 <button onclick="openAdmin()">Administración</button>
</div>

<div id="adminPanel" class="hidden">
 <h3>Administración</h3>

 <input type="password" id="adminPin" placeholder="PIN admin">
 <button onclick="loginAdmin()">Entrar</button>

 <div id="adminContent" class="hidden">
  <button onclick="toggleCoins()">Mostrar / Ocultar monedas</button>
  <button onclick="resetGame()">Cerrar juego</button>
  <button onclick="closeAdmin()">X</button>

  <h4>Editar fichas</h4>
  <div id="adminList"></div>
 </div>
</div>

</div>

<script>
const firebaseConfig={
 apiKey:"AIzaSyAFbvgQ90F3LK6bdjIV9ZrklqG7AOa_SP8",
 authDomain:"empyre-singles-4d9e5.firebaseapp.com",
 projectId:"empyre-singles-4d9e5",
 storageBucket:"empyre-singles-4d9e5.firebasestorage.app",
 messagingSenderId:"131407484794",
 appId:"1:131407484794:web:1041dce4e48264713368c3"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let isAdmin=false;
let showCoins=false;
let chart;

function enter(){
 if(accessPin.value==="2025"){
  access.classList.add("hidden");
  app.classList.remove("hidden");
 }
}

function openAdmin(){
 adminPanel.classList.remove("hidden");
}

function loginAdmin(){
 if(adminPin.value==="0204"){
  isAdmin=true;
  adminContent.classList.remove("hidden");
 }
}

function closeAdmin(){
 isAdmin=false;
 adminPanel.classList.add("hidden");
 adminContent.classList.add("hidden");
 adminPin.value="";
}

function createCard(){
 if(!userInput.value||!fetishInput.value)return;
 db.collection("cards").add({
  user:userInput.value,
  fetish:fetishInput.value,
  coins:10,
  price:0
 });
 userInput.value="";
 fetishInput.value="";
}

function toggleCoins(){
 showCoins=!showCoins;
}

function resetGame(){
 if(confirm("¿Cerrar juego y borrar todo?")){
  db.collection("cards").get().then(s=>{
   s.forEach(d=>d.ref.delete());
  });
  showCoins=false;
 }
}

function deleteCard(id){
 if(confirm("¿Borrar ficha?")){
  db.collection("cards").doc(id).delete();
 }
}

db.collection("cards").onSnapshot(s=>{
 cards.innerHTML="";
 adminList.innerHTML="";
 const graph=[];

 s.forEach(d=>{
  const c=d.data();

  // PUBLIC CARD
  const div=document.createElement("div");
  div.className="card";
  div.innerHTML=`
   <span class="delete" onclick="deleteCard('${d.id}')">X</span>
   <b>${c.user}</b><br>
   ${c.fetish}<br>
   Redpoints: ${showCoins?c.coins:"??"}<br>
   Precio: ${c.price}
  `;
  cards.appendChild(div);

  // ADMIN CARD
  if(isAdmin){
   const a=document.createElement("div");
   a.className="admin-card";
   a.innerHTML=`
    <b>${c.user}</b><br>
    <input type="number" placeholder="Redpoints" value="${c.coins}" id="coins-${d.id}">
    <input type="number" placeholder="Precio" value="${c.price}" id="price-${d.id}">
    <button onclick="save('${d.id}')">Guardar</button>
   `;
   adminList.appendChild(a);
  }

  graph.push({u:c.user,c:c.coins});
 });

 updateChart(graph);
});

function save(id){
 const coins=document.getElementById("coins-"+id).value;
 const price=document.getElementById("price-"+id).value;
 db.collection("cards").doc(id).update({
  coins:Number(coins),
  price:Number(price)
 });
}

function updateChart(data){
 if(chart)chart.destroy();
 chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{
   labels:data.map(d=>d.u),
   datasets:[{
    data:data.map(d=>d.c),
    borderColor:"#e10600",
    fill:false
   }]
  },
  options:{plugins:{legend:{display:false}}}
 });
}
</script>

</body>
</html>
