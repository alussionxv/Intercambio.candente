<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Empyre Singles</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{
  margin:0;
  padding:0;
  background:#000;
  color:#fff;
  font-family:Arial,sans-serif;
  width:100%;
  min-width:320px;
  overflow-x:hidden;
}
.container{max-width:400px;margin:auto;padding:10px;box-sizing:border-box;}
header{text-align:center;padding:10px;}
h1{color:#e10600;font-size:28px;margin:0;}
h2{font-weight:normal;margin-top:3px;font-size:14px;}
input, button{
  padding:6px 12px;
  font-size:13px;
  border-radius:5px;
  margin:4px 2px;
  border:1px solid #e10600;
  background:#111;
  color:#fff;
  box-sizing:border-box;
}
input{width:100%; max-width:250px;}
button{min-width:80px; max-width:140px; cursor:pointer;}
#cards{max-height:300px;overflow-y:auto;}
.card{height:70px;display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-radius:6px;border:1px solid #e10600;margin:4px 0;font-size:13px;background:#0b0b0b;box-sizing:border-box;}
.card-info{display:flex;flex-direction:column;justify-content:center;}
.delete{cursor:pointer;color:#e10600;font-weight:bold;margin-left:4px;}
.footer{position:fixed;bottom:0;width:100%;background:#050505;padding:8px;text-align:center;font-size:12px;}
#adminPanel{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;justify-content:center;align-items:center;flex-direction:column;overflow-y:auto;padding:10px;box-sizing:border-box;display:none;}
#adminContent{width:100%;max-width:380px;background:#111;padding:10px;border-radius:8px;display:flex;flex-direction:column;}
#adminContent h3,h4{margin:5px 0;}
.admin-card{border:1px solid #333;padding:4px;margin:2px;border-radius:4px;display:flex;flex-direction:column;}
.admin-card input, .admin-card button{width:auto;margin:2px;padding:3px 6px;font-size:12px;}
canvas{margin-top:5px;width:100% !important;height:180px !important;}
</style>
</head>
<body>

<div id="access" class="container">
 <h2>Clave de acceso</h2>
 <input type="password" id="accessPin" placeholder="Introduce clave">
 <button onclick="enter()">Entrar</button>
</div>

<script>
let accessPassword="2025";
let adminPassword="0204";
let isAdmin=false;
let appContainer=null;
let adminPanel=null;
let chart=null;

// Firebase
firebase.initializeApp({
 apiKey:"AIzaSyAFbvgQ90F3LK6bdjIV9ZrklqG7AOa_SP8",
 authDomain:"empyre-singles-4d9e5.firebaseapp.com",
 projectId:"empyre-singles-4d9e5"
});
const db=firebase.firestore();
const stateRef=db.collection("state").doc("game");
stateRef.get().then(d=>{if(!d.exists){stateRef.set({showCoins:false});}});

// ACCESO
function enter(){
  const pin=document.getElementById("accessPin").value;
  if(pin===accessPassword){
    document.getElementById("access").remove();
    renderApp();
  } else alert("Clave incorrecta");
}

// RENDER APP DINÁMICO
function renderApp(){
  appContainer=document.createElement("div");
  appContainer.id="app";
  appContainer.innerHTML=`
<header>
 <h1>Empyre Singles</h1>
 <h2>Intercambio candente</h2>
</header>
<div class="container">
<h3>Crear ficha</h3>
<input id="userInput" placeholder="@usuario">
<input id="fetishInput" placeholder="Fetiche">
<p>Redpoints: ??</p>
<button onclick="createCard()">Crear</button>
<div id="cards"></div>
<canvas id="chart"></canvas>
</div>
<div class="footer">
 <button onclick="openAdmin()">Administración</button>
</div>
`;
  document.body.appendChild(appContainer);

  // ADMIN PANEL
  adminPanel=document.createElement("div");
  adminPanel.id="adminPanel";
  adminPanel.innerHTML=`
<div id="adminContent">
  <button style="align-self:flex-end;" onclick="closeAdmin()">X</button>
  <h3>Administración</h3>
  <input type="password" id="adminPin" placeholder="PIN admin">
  <button onclick="loginAdmin()">Entrar</button>
  <div id="adminList" class="hidden"></div>
  <button onclick="toggleCoins()">Mostrar / Ocultar monedas</button>
  <button onclick="resetGame()">Cerrar juego</button>
  <h4>Cambiar contraseña de acceso</h4>
  <input type="password" id="newAccessPin" placeholder="Nueva clave de acceso">
  <button onclick="changeAccessPin()">Guardar clave</button>
</div>
`;
  document.body.appendChild(adminPanel);

  // Listeners y render inicial
  db.collection("cards").onSnapshot(renderCards);
  stateRef.onSnapshot(renderCards);
}

// FUNCIONES CREAR, BORRAR, TOGGLE, RESET, ADMIN ETC.
function createCard(){
  const u=document.getElementById("userInput").value;
  const f=document.getElementById("fetishInput").value;
  if(!u||!f)return;
  db.collection("cards").add({user:u,fetish:f,coins:10,price:0});
  document.getElementById("userInput").value="";
  document.getElementById("fetishInput").value="";
}
function deleteCard(id){if(confirm("¿Borrar ficha?")) db.collection("cards").doc(id).delete();}
function toggleCoins(){stateRef.get().then(d=>stateRef.update({showCoins:!d.data().showCoins}));}
function resetGame(){if(confirm("¿Cerrar juego y borrar todo?")){db.collection("cards").get().then(s=>s.forEach(d=>d.ref.delete()));stateRef.set({showCoins:false});}}
function changeAccessPin(){const n=document.getElementById("newAccessPin").value;if(n){accessPassword=n;alert("Clave de acceso cambiada!");document.getElementById("newAccessPin").value="";}}

// ADMIN
function openAdmin(){adminPanel.style.display="flex";}
function closeAdmin(){isAdmin=false;adminPanel.style.display="none";document.getElementById("adminList").classList.add("hidden");document.getElementById("adminPin").value="";}
function loginAdmin(){
  if(document.getElementById("adminPin").value===adminPassword){
    isAdmin=true;
    document.getElementById("adminList").classList.remove("hidden");
    renderCards();
  } else alert("PIN incorrecto");
}
function save(id){
 const coins=document.getElementById("coins-"+id).value;
 const price=document.getElementById("price-"+id).value;
 db.collection("cards").doc(id).update({coins:Number(coins),price:Number(price)});
}

// RENDER FICHAS Y GRAFICA
function renderCards(){
  db.collection("cards").get().then(s=>{
    stateRef.get().then(st=>{
      const visible=st.data().showCoins;
      const cardsDiv=document.getElementById("cards");
      const adminList=document.getElementById("adminList");
      cardsDiv.innerHTML="";
      if(isAdmin) adminList.innerHTML="";
      const graph=[];
      s.forEach(d=>{
        const c=d.data();
        const div=document.createElement("div");
        div.className="card";
        div.innerHTML=`<div class="card-info"><b>${c.user}</b> | ${c.fetish} <br>Redpoints: ${visible?c.coins:"??"} | Precio: ${c.price}</div><span class="delete" data-id="${d.id}">X</span>`;
        cardsDiv.appendChild(div);

        if(c.coins>=20 && !c.alerted){
          alert(`${c.user} alcanzó 20 Redpoints! Toma captura y comparte en el grupo.`);
          db.collection("cards").doc(d.id).update({alerted:true});
        }

        if(isAdmin){
          const a=document.createElement("div");
          a.className="admin-card";
          a.innerHTML=`<b>${c.user}</b><br>Coins: <input type="number" id="coins-${d.id}" value="${c.coins}"> Precio: <input type="number" id="price-${d.id}" value="${c.price}"> <button onclick="save('${d.id}')">Guardar</button>`;
          adminList.appendChild(a);
        }
        graph.push({u:c.user,c:c.coins});
      });

      if(chart) chart.destroy();
      chart=new Chart(document.getElementById("chart"),{type:"line",data:{labels:graph.map(d=>d.u),datasets:[{data:graph.map(d=>d.c),borderColor:"#e10600",fill:false}]},options:{plugins:{legend:{display:false}}}});
    });
  });
}

// EVENT DELEGATION BORRAR
document.addEventListener('click',e=>{if(e.target.classList.contains('delete')) deleteCard(e.target.dataset.id);});
</script>
</body>
</html>
